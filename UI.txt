import streamlit as st
import torch
import torch.nn.functional as F
from torchvision import transforms
from PIL import Image
import timm

# -------------------------
# –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
# -------------------------
st.set_page_config(page_title="Tomato Disease Classifier üçÖ", page_icon="üçÖ", layout="wide")

# -------------------------
# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ
# -------------------------
MODEL_PATH = r"C:\Users\zalut\PycharmProjects\TomatoGPU_ViT\vit_tomato_model.pth"
model = timm.create_model("vit_base_patch16_224", pretrained=False, num_classes=11)
model.load_state_dict(torch.load(MODEL_PATH, map_location='cpu'))
model.eval()

# -------------------------
# –ù–∞–∑–≤–∏ —Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
# -------------------------
labels_ua = [
    "–ë–∞–∫—Ç–µ—Ä—ñ–∞–ª—å–Ω–∞ –ø–ª—è–º–∏—Å—Ç—ñ—Å—Ç—å",
    "–†–∞–Ω–Ω—è —Ñ—ñ—Ç–æ—Ñ—Ç–æ—Ä–∞",
    "–ó–¥–æ—Ä–æ–≤–∞ —Ä–æ—Å–ª–∏–Ω–∞",
    "–ü—ñ–∑–Ω—è —Ñ—ñ—Ç–æ—Ñ—Ç–æ—Ä–∞",
    "–¶–≤—ñ–ª—å –ª–∏—Å—Ç—è",
    "–ë–æ—Ä–æ—à–Ω–∏—Å—Ç–∞ —Ä–æ—Å–∞",
    "–°–µ–ø—Ç–æ—Ä—ñ–æ–∑ –ª–∏—Å—Ç—è",
    "–ü–∞–≤—É—Ç–∏–Ω–Ω–∏–π –∫–ª—ñ—â",
    "–¢–∞—Ä–≥–µ—Ç-—Å–ø–æ—Ç (–ø–ª—è–º–∏—Å—Ç–∞ —Ö–≤–æ—Ä–æ–±–∞)",
    "–¢–æ–º–∞—Ç–Ω–∏–π –º–æ–∑–∞—ó—á–Ω–∏–π –≤—ñ—Ä—É—Å",
    "–í—ñ—Ä—É—Å –∂–æ–≤—Ç–æ—ó –∫—É—á–µ—Ä—è–≤–æ—Å—Ç—ñ –ª–∏—Å—Ç–∫—ñ–≤ —Ç–æ–º–∞—Ç—É"
]

recommendations = {
    "–ë–∞–∫—Ç–µ—Ä—ñ–∞–ª—å–Ω–∞ –ø–ª—è–º–∏—Å—Ç—ñ—Å—Ç—å": "üî∏ –£–Ω–∏–∫–∞–π—Ç–µ –ø–æ–ª–∏–≤—É –∑–≤–µ—Ä—Ö—É, –≤–∏–¥–∞–ª—è–π—Ç–µ —É—Ä–∞–∂–µ–Ω–µ –ª–∏—Å—Ç—è. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –º—ñ–¥—å–≤–º—ñ—Å–Ω—ñ —Ñ—É–Ω–≥—ñ—Ü–∏–¥–∏ (—Ö–ª–æ—Ä–æ–∫–∏—Å –º—ñ–¥—ñ).",
    "–†–∞–Ω–Ω—è —Ñ—ñ—Ç–æ—Ñ—Ç–æ—Ä–∞": "üü¢ –ü–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ –Ω–∏–∂–Ω—ñ—Ö –ª–∏—Å—Ç–∫—ñ–≤. –ó–∞–±–µ–∑–ø–µ—á—Ç–µ –≤–µ–Ω—Ç–∏–ª—è—Ü—ñ—é, –æ–±—Ä–æ–±—ñ—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞–º–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ö–ª–æ—Ä–æ—Ç–∞–ª–æ–Ω—ñ–ª—É –∞–±–æ –º–∞–Ω–∫–æ—Ü–µ–±—É.",
    "–ó–¥–æ—Ä–æ–≤–∞ —Ä–æ—Å–ª–∏–Ω–∞": "‚úÖ –õ–∏—Å—Ç–∫–∏ –±–µ–∑ –ø–æ—à–∫–æ–¥–∂–µ–Ω—å. –ü—ñ–¥—Ç—Ä–∏–º—É–π—Ç–µ –±–∞–ª–∞–Ω—Å –ø–æ–ª–∏–≤—É —ñ –ø–æ–∂–∏–≤–Ω–∏—Ö —Ä–µ—á–æ–≤–∏–Ω.",
    "–ü—ñ–∑–Ω—è —Ñ—ñ—Ç–æ—Ñ—Ç–æ—Ä–∞": "‚ö†Ô∏è –î—É–∂–µ –Ω–µ–±–µ–∑–ø–µ—á–Ω–∞ —Ö–≤–æ—Ä–æ–±–∞. –í–∏–¥–∞–ª—ñ—Ç—å —É—Ä–∞–∂–µ–Ω–µ –ª–∏—Å—Ç—è, –∑–∞—Å—Ç–æ—Å—É–π—Ç–µ –º–µ—Ç–∞–ª–∞–∫—Å–∏–ª —á–∏ –º–∞–Ω–∫–æ—Ü–µ–±.",
    "–¶–≤—ñ–ª—å –ª–∏—Å—Ç—è": "üü° –ó–∞–∑–≤–∏—á–∞–π —É —Ç–µ–ø–ª–∏—Ü—è—Ö. –ü—Ä–æ–≤—ñ—Ç—Ä—é–π—Ç–µ, –∑–º–µ–Ω—à—ñ—Ç—å –ø–æ–ª–∏–≤, –æ–±–ø—Ä–∏—Å–∫–∞–π—Ç–µ –±—ñ–æ—Ñ—É–Ω–≥—ñ—Ü–∏–¥–∞–º–∏.",
    "–ë–æ—Ä–æ—à–Ω–∏—Å—Ç–∞ —Ä–æ—Å–∞": "üå´Ô∏è –ë—ñ–ª–∏–π –Ω–∞–ª—ñ—Ç. –£–Ω–∏–∫–∞–π—Ç–µ –Ω–∞–¥–ª–∏—à–∫—É –∞–∑–æ—Ç—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∏ –∑ —Å—ñ—Ä–∫–æ—é –∞–±–æ –º–æ–ª–æ–∫–æ–º (1:10).",
    "–°–µ–ø—Ç–æ—Ä—ñ–æ–∑ –ª–∏—Å—Ç—è": "‚ö™ –ú–∞–ª–µ–Ω—å–∫—ñ —Å–≤—ñ—Ç–ª—ñ –ø–ª—è–º–∏. –í–∏–¥–∞–ª—ñ—Ç—å –ª–∏—Å—Ç—è, –Ω–µ –ø–æ–ª–∏–≤–∞–π—Ç–µ –∑–≤–µ—Ä—Ö—É, –∑–∞—Å—Ç–æ—Å—É–π—Ç–µ —Ö–ª–æ—Ä–æ—Ç–∞–ª–æ–Ω—ñ–ª.",
    "–ü–∞–≤—É—Ç–∏–Ω–Ω–∏–π –∫–ª—ñ—â": "üï∑Ô∏è –¢–æ–Ω–∫–∞ –ø–∞–≤—É—Ç–∏–Ω–∞, —Å–≤—ñ—Ç–ª—ñ –ø–ª—è–º–∏. –ü—ñ–¥–≤–∏—â—ñ—Ç—å –≤–æ–ª–æ–≥—ñ—Å—Ç—å, –∑–∞—Å—Ç–æ—Å—É–π—Ç–µ –∞–±–∞–º–µ–∫—Ç–∏–Ω.",
    "–¢–∞—Ä–≥–µ—Ç-—Å–ø–æ—Ç (–ø–ª—è–º–∏—Å—Ç–∞ —Ö–≤–æ—Ä–æ–±–∞)": "üü§ –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—á–Ω—ñ –ø–ª—è–º–∏. –í–∏–¥–∞–ª—ñ—Ç—å —É—Ä–∞–∂–µ–Ω–µ –ª–∏—Å—Ç—è, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∞–∑–æ–∫—Å–∏—Å—Ç—Ä–æ–±—ñ–Ω.",
    "–¢–æ–º–∞—Ç–Ω–∏–π –º–æ–∑–∞—ó—á–Ω–∏–π –≤—ñ—Ä—É—Å": "üß¨ –ú–æ–∑–∞—ó—á–Ω–µ –∑–∞–±–∞—Ä–≤–ª–µ–Ω–Ω—è. –í–∏–¥–∞–ª—ñ—Ç—å —É—Ä–∞–∂–µ–Ω—ñ —Ä–æ—Å–ª–∏–Ω–∏, –¥–µ–∑—ñ–Ω—Ñ—ñ–∫—É–π—Ç–µ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏.",
    "–í—ñ—Ä—É—Å –∂–æ–≤—Ç–æ—ó –∫—É—á–µ—Ä—è–≤–æ—Å—Ç—ñ –ª–∏—Å—Ç–∫—ñ–≤ —Ç–æ–º–∞—Ç—É": "üíõ –ó–∞–∫—Ä—É—á—É–≤–∞–Ω–Ω—è –ª–∏—Å—Ç–∫—ñ–≤. –ö–æ–Ω—Ç—Ä–æ–ª—é–π—Ç–µ –±—ñ–ª–æ–∫—Ä–∏–ª–∫—É, —Å—Ç–∞–≤—Ç–µ –∂–æ–≤—Ç—ñ –ø–∞—Å—Ç–∫–∏."
}

# -------------------------
# –ü–µ—Ä–µ–¥–æ–±—Ä–æ–±–∫–∞
# -------------------------
transform = transforms.Compose([
    transforms.Resize((224, 224)),
    transforms.ToTensor(),
    transforms.Normalize(mean=[0.485, 0.456, 0.406],
                         std=[0.229, 0.224, 0.225])
])

def predict(img):
    img_t = transform(img).unsqueeze(0)
    with torch.no_grad():
        out = model(img_t)
        probs = F.softmax(out, dim=1)
        conf, pred = torch.max(probs, 1)
    return labels_ua[pred.item()], conf.item()

# -------------------------
# UI
# -------------------------
st.markdown("<h1 style='text-align:center; color:#2e7d32;'>üåø Tomato Disease Classifier üçÖ</h1>", unsafe_allow_html=True)
st.markdown("<h5 style='text-align:center; color:#555;'>AI-–∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ö–≤–æ—Ä–æ–± –ª–∏—Å—Ç—è —Ç–æ–º–∞—Ç—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Vision Transformer (ViT)</h5>", unsafe_allow_html=True)
st.write("")

uploaded_file = st.file_uploader("üì∏ –û–±–µ—Ä—ñ—Ç—å –∞–±–æ –ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ª–∏—Å—Ç–∫–∞", type=["jpg", "jpeg", "png"])

if uploaded_file:
    image = Image.open(uploaded_file).convert("RGB")

    # --- –¥–≤—ñ –∫–æ–ª–æ–Ω–∫–∏ ---
    col1, col2 = st.columns([1.2, 1])  # —Å–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è —à–∏—Ä–∏–Ω–∏

    with col1:
        st.image(image, caption="üì∑ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è", use_column_width=True, output_format="JPEG")

    with col2:
        if st.button("üîç –ö–ª–∞—Å–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏"):
            label, conf = predict(image)
            st.markdown(f"### ü©∫ –í–∏—è–≤–ª–µ–Ω–æ: **{label}**")
            st.progress(float(conf))
            st.write(f"**–ô–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å:** {conf * 100:.2f}%")

            st.markdown("---")
            st.markdown("### üå± –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:")
            st.markdown(recommendations[label])

            st.info("üìò –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –¥—ñ–∞–≥–Ω–æ–∑—É –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–≥—Ä–æ–Ω–æ–º–∞ –∞–±–æ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó.")
else:
    st.warning("‚¨ÜÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–æ—Ç–æ, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.")

st.markdown("<p style='text-align:center; color:#999;'>–†–æ–∑—Ä–æ–±–ª–µ–Ω–æ —É Python + PyTorch + Streamlit üíö</p>", unsafe_allow_html=True)
